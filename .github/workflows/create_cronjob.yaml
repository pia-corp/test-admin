# ===================================================
# å…¬é–‹äºˆç´„è¨­å®šã®æ–°è¦ä½œæˆãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ (åˆå›žã®ã¿å®Ÿè¡Œ)
# ===================================================
#
# ã€æ¦‚è¦ã€‘
# ã“ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯ã€æŒ‡å®šã•ã‚ŒãŸãƒªãƒã‚¸ãƒˆãƒªåã«å¯¾ã—ã¦æ–°è¦ã®Cronã‚¸ãƒ§ãƒ–ã‚’
# cron-job.orgä¸Šã«ä½œæˆã—ã¾ã™ã€‚ã“ã®ã‚¸ãƒ§ãƒ–ã¯GitHub Actionsãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’
# å®šæœŸçš„ã«ãƒˆãƒªã‚¬ãƒ¼ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚
#
# ã€å‰ææ¡ä»¶ã€‘
# - cron-job.orgã®APIãƒˆãƒ¼ã‚¯ãƒ³ (CRON_JOB_TOKEN) ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã“ã¨
# - GitHubãƒ‘ãƒ¼ã‚½ãƒŠãƒ«ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ (GIT_PERSONAL_ACCESS_TOKEN) ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã“ã¨
# - å¯¾è±¡ãƒªãƒã‚¸ãƒˆãƒªãŒpia-corpçµ„ç¹”å†…ã«å­˜åœ¨ã™ã‚‹ã“ã¨
#
# ã€ä½¿ç”¨æ–¹æ³•ã€‘
# ã“ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯æ‰‹å‹•ã§ãƒˆãƒªã‚¬ãƒ¼ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
# å®Ÿè¡Œæ™‚ã«ã€Œç™»éŒ²ã™ã‚‹ãƒªãƒã‚¸ãƒˆãƒªåã€ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æŒ‡å®šã—ã¦ãã ã•ã„ã€‚
#
# ã€æ³¨æ„äº‹é …ã€‘
# - ã“ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯åˆå›žã®ã¿å®Ÿè¡Œã—ã¦ãã ã•ã„
# - åŒã˜åå‰ã®Cronã‚¸ãƒ§ãƒ–ãŒæ—¢ã«å­˜åœ¨ã™ã‚‹å ´åˆã¯ã‚¨ãƒ©ãƒ¼ã«ãªã‚Šã¾ã™
# - ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ä½œæˆã•ã‚ŒãŸCronã‚¸ãƒ§ãƒ–ã¯ç„¡åŠ¹çŠ¶æ…‹ã§ã™
#
# ===================================================

name: 05.å…¬é–‹äºˆç´„è¨­å®šã®æ–°è¦ä½œæˆ(åˆå›žã®ã¿å®Ÿè¡Œ)

on:
  workflow_dispatch:
    inputs:
      repository_name:
        description: "ç™»éŒ²ã™ã‚‹ãƒªãƒã‚¸ãƒˆãƒªå"
        required: true
        type: string

permissions:
  contents: write

jobs:
  create_cron_job:
    runs-on: ubuntu-latest
    timeout-minutes: 1
    env:
      # å¯¾è±¡ãƒªãƒã‚¸ãƒˆãƒªã®è¨­å®šï¼ˆç’°å¢ƒã«å¿œã˜ã¦å¤‰æ›´å¯èƒ½ï¼‰
      target_repository: "test-admin"
      # APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
      cron_job_api_url: "https://api.cron-job.org/jobs"
      github_api_url: "https://api.github.com"

    steps:
      # =============================
      # ã‚¹ãƒ†ãƒƒãƒ—1: å…¥åŠ›ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®æ¤œè¨¼ã¨ã‚¿ã‚¤ãƒˆãƒ«è¨­å®š
      # =============================
      - name: å…¬é–‹äºˆç´„è¨­å®šã®ã‚¿ã‚¤ãƒˆãƒ«ã‚’æ¤œè¨¼ã¨è¨­å®š
        id: validate_and_set_title
        run: |
          # å…¥åŠ›ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼ˆãƒªãƒã‚¸ãƒˆãƒªåï¼‰ãŒç©ºã§ãªã„ã“ã¨ã‚’ç¢ºèª
          if [ -z "${{ inputs.repository_name }}" ]; then
            echo "::error:: 'ç™»éŒ²ã™ã‚‹ãƒªãƒã‚¸ãƒˆãƒªå' ãŒæœªå…¥åŠ›ã§ã™ã€‚å…¥åŠ›ã—ã¦ã‹ã‚‰å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚"
            exit 1
          fi

          # ç’°å¢ƒå¤‰æ•°ã«Cronã‚¸ãƒ§ãƒ–ã®ã‚¿ã‚¤ãƒˆãƒ«ã‚’ã‚»ãƒƒãƒˆï¼ˆå¾Œç¶šã‚¹ãƒ†ãƒƒãƒ—ã§ä½¿ç”¨ï¼‰
          echo "cron_job_title=${{ inputs.repository_name }}" >> $GITHUB_ENV
          echo "âœ“ Cronã‚¸ãƒ§ãƒ–ã‚¿ã‚¤ãƒˆãƒ«ã‚’ '${{ inputs.repository_name }}' ã«è¨­å®šã—ã¾ã—ãŸ"

      # =============================
      # ã‚¹ãƒ†ãƒƒãƒ—2: æ—¢å­˜ã®Cronã‚¸ãƒ§ãƒ–ã¨ã®é‡è¤‡ç¢ºèª
      # =============================
      - name: åŒåã®Cronã‚¸ãƒ§ãƒ–ãŒæ—¢ã«å­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
        id: check_existing_job
        run: |
          echo "ðŸ” æ—¢å­˜ã®Cronã‚¸ãƒ§ãƒ–ã‚’ç¢ºèªã—ã¦ã„ã¾ã™..."

          # Cron-job.orgã®APIã‹ã‚‰ç¾åœ¨ã®ã‚¸ãƒ§ãƒ–ä¸€è¦§ã‚’å–å¾—
          # curlã‚³ãƒžãƒ³ãƒ‰ãŒå¤±æ•—ã—ãŸå ´åˆã¯è©³ç´°ãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
          api_response=$(curl -s -X GET \
            -H "Authorization: Bearer ${{ secrets.CRON_JOB_TOKEN }}" \
            ${{ env.cron_job_api_url }}) || {
              echo "::error:: Cronã‚¸ãƒ§ãƒ–ä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚"
              echo "ã‚¨ãƒ©ãƒ¼è©³ç´°: $(curl -s -X GET -H "Authorization: Bearer ${{ secrets.CRON_JOB_TOKEN }}" ${{ env.cron_job_api_url }})"
              exit 1
            }

          # åŒã˜ã‚¿ã‚¤ãƒˆãƒ«ã®ã‚¸ãƒ§ãƒ–ãŒå­˜åœ¨ã™ã‚‹ã‹jqã‚³ãƒžãƒ³ãƒ‰ã§ç¢ºèª
          # jqã¯JSONå½¢å¼ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‡¦ç†ã™ã‚‹ãŸã‚ã®ã‚³ãƒžãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ãƒ„ãƒ¼ãƒ«
          existing_job=$(echo "$api_response" | jq -r --arg title "${{ env.cron_job_title }}" '.jobs[] | select(.url | contains($title)) | .url')

          # é‡è¤‡ãŒã‚ã‚‹å ´åˆã¯ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã—ã¦å‡¦ç†ã‚’çµ‚äº†
          if [ -n "$existing_job" ]; then
            echo "::error:: ã‚¿ã‚¤ãƒˆãƒ« '${{ env.cron_job_title }}' ã®Cronã‚¸ãƒ§ãƒ–ã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™ã€‚åˆ¥ã®åå‰ã‚’æŒ‡å®šã—ã¦ãã ã•ã„ã€‚"
            exit 1
          fi

          echo "âœ“ '${{ env.cron_job_title }}' ã¨ã„ã†åå‰ã®Cronã‚¸ãƒ§ãƒ–ã¯å­˜åœ¨ã—ãªã„ã“ã¨ã‚’ç¢ºèªã—ã¾ã—ãŸ"

      # =============================
      # ã‚¹ãƒ†ãƒƒãƒ—3: æ–°è¦Cronã‚¸ãƒ§ãƒ–ã®ä½œæˆ
      # =============================
      - name: æ–°è¦Cronã‚¸ãƒ§ãƒ–ã®ä½œæˆã¨è¨­å®š
        id: create_cron_job
        run: |
          echo "ðŸ”§ æ–°è¦Cronã‚¸ãƒ§ãƒ–ã‚’ä½œæˆã—ã¦ã„ã¾ã™..."

          # Cronã‚¸ãƒ§ãƒ–ã®è¨­å®šå†…å®¹ã‚’å¤‰æ•°ã«æ ¼ç´ï¼ˆå¯èª­æ€§å‘ä¸Šã®ãŸã‚ï¼‰
          # æ³¨æ„: å®Ÿéš›ã®APIãƒªã‚¯ã‚¨ã‚¹ãƒˆã§ä½¿ç”¨ã•ã‚Œã‚‹å½¢å¼ã§ã™
          job_config='{
            "job": {
              "url": "${{ env.github_api_url }}/repos/pia-corp/${{ env.target_repository }}/dispatches",
              "enabled": false,
              "saveResponses": false,
              "title": "${{ env.cron_job_title }}",
              "schedule": {
                "expiresAt": 0,
                "timezone": "Asia/Tokyo",
                "hours": [-1],
                "mdays": [-1],
                "minutes": [-1],
                "months": [-1],
                "wdays": [-1]
              },
              "extendedData": {
                "headers": {
                  "Accept": "application/vnd.github+json",
                  "Authorization": "Bearer ${{ secrets.GIT_PERSONAL_ACCESS_TOKEN }}",
                  "X-GitHub-Api-Version": "2022-11-28"
                },
                "body": "{\"event_type\": \"init\"}"
              },
              "requestMethod": 1
            }
          }'

          # å¤‰æ•°å±•é–‹ã‚’è¡Œã†ãŸã‚ã«ä¸€æ—¦envsubã‚³ãƒžãƒ³ãƒ‰ã‚’é€šã™
          job_config_expanded=$(echo "$job_config" | envsubst)

          # Cron-job.orgã®APIã‚’ä½¿ç”¨ã—ã¦æ–°è¦ã‚¸ãƒ§ãƒ–ã‚’ä½œæˆ
          creation_response=$(curl -s -X PUT \
            -H 'Content-Type: application/json' \
            -H "Authorization: Bearer ${{ secrets.CRON_JOB_TOKEN }}" \
            -d "$job_config_expanded" \
            ${{ env.cron_job_api_url }}) || {
              echo "::error:: Cronã‚¸ãƒ§ãƒ–ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚"
              echo "ã‚¨ãƒ©ãƒ¼è©³ç´°: $creation_response"
              exit 1
            }

          # APIã‹ã‚‰ã®å¿œç­”ã‚’ãƒ­ã‚°ã«è¨˜éŒ²ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
          echo "APIãƒ¬ã‚¹ãƒãƒ³ã‚¹: $creation_response"

          # APIãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‹ã‚‰ã‚¸ãƒ§ãƒ–IDã‚’å–å¾—ï¼ˆç¢ºèªç”¨ï¼‰
          job_id=$(echo "$creation_response" | jq -r '.jobId')
          if [ -n "$job_id" ] && [ "$job_id" != "null" ]; then
            echo "âœ“ Cronã‚¸ãƒ§ãƒ–ãŒä½œæˆã•ã‚Œã¾ã—ãŸ (ID: $job_id)"
          else
            echo "âš ï¸ ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‹ã‚‰ã‚¸ãƒ§ãƒ–IDã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ä½œæˆã¯æˆåŠŸã—ãŸå¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚"
          fi

      # =============================
      # ã‚¹ãƒ†ãƒƒãƒ—4: ã‚¸ãƒ§ãƒ–ä½œæˆã®æˆåŠŸç¢ºèªã¨çµæžœå ±å‘Š
      # =============================
      - name: Cronã‚¸ãƒ§ãƒ–ä½œæˆã®ç¢ºèªã¨çµæžœå ±å‘Š
        id: verify_job_creation
        run: |
          echo "ðŸ” ä½œæˆã—ãŸCronã‚¸ãƒ§ãƒ–ã‚’ç¢ºèªã—ã¦ã„ã¾ã™..."

          # å°‘ã—å¾…æ©Ÿã—ã¦APIã®åæ˜ ã‚’å¾…ã¤ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
          sleep 2

          # Cron-job.orgã®APIã‹ã‚‰ç¾åœ¨ã®ã‚¸ãƒ§ãƒ–ä¸€è¦§ã‚’å†å–å¾—
          verification_response=$(curl -s -X GET \
            -H "Authorization: Bearer ${{ secrets.CRON_JOB_TOKEN }}" \
            ${{ env.cron_job_api_url }}) || {
              echo "::error:: Cronã‚¸ãƒ§ãƒ–ä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚"
              echo "ã‚¨ãƒ©ãƒ¼è©³ç´°: $(curl -s -X GET -H "Authorization: Bearer ${{ secrets.CRON_JOB_TOKEN }}" ${{ env.cron_job_api_url }})"
              exit 1
            }

          # ä½œæˆã—ãŸã‚¸ãƒ§ãƒ–ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
          created_job=$(echo "$verification_response" | jq -r --arg title "${{ env.cron_job_title }}" '.jobs[] | select(.url | contains($title)) | .url')

          # çµæžœã‚’ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®ã‚µãƒžãƒªãƒ¼ã«è¿½åŠ ï¼ˆGitHub Actions UIä¸Šã«è¡¨ç¤ºã•ã‚Œã‚‹ï¼‰
          echo "# å‡¦ç†çµæžœ" >> $GITHUB_STEP_SUMMARY
          if [ -n "$created_job" ]; then
            echo "âœ… ${{ env.cron_job_title }} ã®äºˆç´„å…¬é–‹ã™ã‚‹ãŸã‚ã®åˆæœŸè¨­å®šãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸã€‚" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ”— URL: $created_job" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸ æ³¨æ„: ä½œæˆã•ã‚ŒãŸCronã‚¸ãƒ§ãƒ–ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ç„¡åŠ¹çŠ¶æ…‹ã§ã™ã€‚cron-job.orgã®ç®¡ç†ç”»é¢ã‹ã‚‰æœ‰åŠ¹åŒ–ã—ã¦ãã ã•ã„ã€‚" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ ${{ env.cron_job_title }} ã®äºˆç´„å…¬é–‹ã™ã‚‹ãŸã‚ã®åˆæœŸè¨­å®šã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚" >> $GITHUB_STEP_SUMMARY
          fi

          # æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã®æ‰‹é †ã‚’æ˜Žç¤º
          if [ -n "$created_job" ]; then
            echo "# æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—" >> $GITHUB_STEP_SUMMARY
            echo "1. cron-job.orgã®ç®¡ç†ç”»é¢ã«ãƒ­ã‚°ã‚¤ãƒ³" >> $GITHUB_STEP_SUMMARY
            echo "2. ä½œæˆã•ã‚ŒãŸã‚¸ãƒ§ãƒ–ã®è¨­å®šã‚’ç¢ºèª" >> $GITHUB_STEP_SUMMARY
            echo "3. ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’é©åˆ‡ã«è¨­å®š" >> $GITHUB_STEP_SUMMARY
            echo "4. ã‚¸ãƒ§ãƒ–ã‚’æœ‰åŠ¹åŒ–" >> $GITHUB_STEP_SUMMARY
          fi
