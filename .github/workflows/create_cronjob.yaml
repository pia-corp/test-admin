name: 03.公開予約設定の新規作成

on:
  workflow_dispatch:
    inputs:
      job_title:
        description: "登録するリポジトリ名"
        required: true

jobs:
  Cron:
    runs-on: ubuntu-24.04
    timeout-minutes: 1

    steps:
      - name: CRON JOBのタイトルを設定
        id: set_title
        run: |
          if [ -z "${{ inputs.job_title }}" ]; then
            echo "::error:: '登録するリポジトリ名' が未入力です。"
            exit 1
          fi
          echo "title=${{ inputs.job_title }}" >> $GITHUB_ENV

      - name: 任意のタイトルが既に存在するか確認
        run: |
          response=$(curl -s -X GET \
            -H "Authorization: Bearer ${{ secrets.CRON_JOB_TOKEN }}" \
            https://api.cron-job.org/jobs)

          echo "$response"

          # Check if the title already exists
          title_exists=$(echo "$response" | jq -r --arg title "${{ env.title }}" '.jobs[] | select(.url | contains($title)) | .url')

          echo "$title_exists"

          if [ -n "$title_exists" ]; then
            echo "::error:: タイトル '${{ env.title }}' のCRON JOBは既に存在します。"
            exit 1
          fi

      - name: Create Cron job and Fetch ID
        run: |
          curl -s -X PUT \
            -H 'Content-Type: application/json' \
            -H "Authorization: Bearer ${{ secrets.CRON_TOKEN }}" \
            -d '{
              "job": {
                "url": "https://api.github.com/repos/pia-corp/${{ env.title }}/actions/workflows/upload.yml/dispatches",
                "enabled": false,
                "saveResponses": false,
                "title": "${{ env.title }}",
                "schedule": {
                  "timezone": "Asia/Tokyo",
                  "expiresAt": 1,
                  "hours": [-1],
                  "mdays": [-1],
                  "minutes": [-1],
                  "months": [-1],
                  "wdays": [-1]
                },
                "extendedData": {
                  "headers": {
                    "Authorization": "Bearer ${{ secrets.GIT_PERSONAL_ACCESS_TOKEN }}",
                  },
                  "body":  "main"
                },
                "requestMethod": 1
              }
            }' https://api.cron-job.org/jobs

          {
            echo "# 処理結果"
            echo "${{ env.title }} の初期設定が完了しました。"
          } >> $GITHUB_STEP_SUMMARY
