# ===================================================
# äºˆç´„ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
# ===================================================
#
# ã€æ¦‚è¦ã€‘
# ã“ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯ã€å…¬é–‹äºˆç´„ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ï¼ˆç„¡åŠ¹åŒ–ï¼‰ã™ã‚‹ãŸã‚ã®ã‚‚ã®ã§ã™ã€‚
# CronJob.org APIã‚’ä½¿ç”¨ã—ã¦ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹Cronã‚¸ãƒ§ãƒ–ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’å–å¾—ã—ã€
# enabledãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’falseã«è¨­å®šã™ã‚‹ã“ã¨ã§äºˆç´„ã‚’ç„¡åŠ¹åŒ–ã—ã¾ã™ã€‚
#
# ä¸»ãªãƒ•ãƒ­ãƒ¼:
# 1. æ‰‹å‹•å®Ÿè¡Œã§ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãƒªãƒã‚¸ãƒˆãƒªã‚’æŒ‡å®š
# 2. CronJob.orgã‹ã‚‰ã™ã¹ã¦ã®ã‚¸ãƒ§ãƒ–æƒ…å ±ã‚’å–å¾—
# 3. æŒ‡å®šã•ã‚ŒãŸãƒªãƒã‚¸ãƒˆãƒªã«ä¸€è‡´ã™ã‚‹ã‚¸ãƒ§ãƒ–IDã‚’æŠ½å‡º
# 4. è©²å½“ã‚¸ãƒ§ãƒ–ã®enabledãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’falseã«è¨­å®š
# 5. æ›´æ–°å¾Œã®æƒ…å ±ã‚’å–å¾—ã—ã¦å¤‰æ›´ã‚’ç¢ºèª
# 6. çµæžœã®ã‚µãƒžãƒªãƒ¼ã‚’ä½œæˆ
#
# ã€å‰ææ¡ä»¶ã€‘
# - CRON_JOB_TOKEN: CronJob.org APIã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³
#
# ===================================================

name: 04.å…¬é–‹äºˆç´„ã‚­ãƒ£ãƒ³ã‚»ãƒ«

# =============================
# ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒˆãƒªã‚¬ãƒ¼è¨­å®š
# =============================
on:
  # æ‰‹å‹•å®Ÿè¡Œã®ã¿ã«å¯¾å¿œ
  workflow_dispatch:
    inputs:
      # ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã§é¸æŠžã™ã‚‹ãƒ–ãƒ©ãƒ³ãƒ‰ãƒªã‚¹ãƒˆ
      repository:
        type: choice
        description: "å¯¾è±¡ãƒ–ãƒ©ãƒ³ãƒ‰"
        required: true
        options:
          - "topards.jp"
          - "feliamo.jp"
          - "molak.jp"
          - "ns-collection.jp"
          - "lilmoon.jp"
          - "minette-lens.jp"
          - "mirage-c.jp"
          - "mimuco.jp"
          - "harne.jp"
          - "louer.jp"
          - "lumieu.jp"
          - "puuuuchu.jp"
          - "melady.jp"
          - "melloew.jp"
          - "faloom.jp"
          - "mimicharme.jp"
          - "lensbe.jp"
          - "clainel.jp"
          - "chapun.jp"
          - "resay.jp"
          - "michou.jp"
      # ãƒªã‚¹ãƒˆã«ãªã„ãƒ–ãƒ©ãƒ³ãƒ‰ã‚’æ‰‹å‹•å…¥åŠ›ã™ã‚‹å ´åˆã®å…¥åŠ›æ¬„
      custom_repository:
        description: "ä»»æ„ã®ãƒ–ãƒ©ãƒ³ãƒ‰ãƒªãƒã‚¸ãƒˆãƒªï¼ˆãƒªã‚¹ãƒˆã«ãªã„å ´åˆï¼‰"
        default: ""

# =============================
# ã‚¸ãƒ§ãƒ–å®šç¾©
# =============================
jobs:
  cancel_reservation:
    name: äºˆç´„ã‚­ãƒ£ãƒ³ã‚»ãƒ«å‡¦ç†
    runs-on: ubuntu-latest
    timeout-minutes: 3
    permissions:
      contents: read
      actions: write
    env:
      # ã‚«ã‚¹ã‚¿ãƒ ãƒªãƒã‚¸ãƒˆãƒªãŒå…¥åŠ›ã•ã‚ŒãŸå ´åˆã¯ãã¡ã‚‰ã‚’å„ªå…ˆã€ãªã‘ã‚Œã°ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã§é¸æŠžã•ã‚ŒãŸãƒªãƒã‚¸ãƒˆãƒªã‚’ä½¿ç”¨
      TARGET_REPOSITORY: ${{ inputs.custom_repository != '' && inputs.custom_repository || inputs.repository }}
      # CronJob.org API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
      CRON_API_BASE_URL: "https://api.cron-job.org/jobs"
      # å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«å
      CRON_JOBS_FILE: "cron_jobs.json"
      UPDATED_JOBS_FILE: "updated_jobs.json"

    steps:
      # =============================
      # Step 1: CronJobä¸€è¦§å–å¾—
      # =============================
      - name: CronJobãƒªã‚¹ãƒˆã‚’å–å¾—
        id: fetch_cron_jobs
        run: |
          echo "::group::CronJob APIã‹ã‚‰ã‚¸ãƒ§ãƒ–ä¸€è¦§ã‚’å–å¾—"
          echo "ðŸ“¥ $TARGET_REPOSITORY ã®äºˆç´„æƒ…å ±ã‚’å–å¾—ä¸­..."

          # CronJob APIã‹ã‚‰å…¨ã‚¸ãƒ§ãƒ–æƒ…å ±ã‚’å–å¾—
          # æ³¨æ„: secrets.CRON_JOB_TOKEN ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
          response=$(curl -s -X GET \
              -H 'Content-Type: application/json' \
              -H 'Authorization: Bearer ${{ secrets.CRON_JOB_TOKEN }}' \
              ${{ env.CRON_API_BASE_URL }}) || {
                echo "âŒ ã‚¨ãƒ©ãƒ¼: CronJobãƒªã‚¹ãƒˆã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ"
                echo "ðŸ” è€ƒãˆã‚‰ã‚Œã‚‹åŽŸå› :"
                echo "  - CRON_JOB_TOKEN ãŒç„¡åŠ¹ã¾ãŸã¯æœŸé™åˆ‡ã‚Œ"
                echo "  - CronJob.org API ã¸ã®æŽ¥ç¶šã‚¨ãƒ©ãƒ¼"
                exit 1
              }

          # å–å¾—ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
          echo "$response" > ${CRON_JOBS_FILE}
          echo "âœ… ã‚¸ãƒ§ãƒ–ãƒªã‚¹ãƒˆã‚’ ${CRON_JOBS_FILE} ã«ä¿å­˜ã—ã¾ã—ãŸ"
          echo "::endgroup::"

      # =============================
      # Step 2: å¯¾è±¡ã‚¸ãƒ§ãƒ–æƒ…å ±æŠ½å‡º
      # =============================
      - name: å¯¾è±¡ã‚¸ãƒ§ãƒ–ã®æƒ…å ±ã‚’æŠ½å‡º
        id: extract_job_info
        run: |
          echo "::group::å¯¾è±¡ã‚¸ãƒ§ãƒ–ã®æƒ…å ±æŠ½å‡º"
          echo "ðŸ” $TARGET_REPOSITORY ã®ã‚¸ãƒ§ãƒ–æƒ…å ±ã‚’æ¤œç´¢ä¸­..."

          # å¯¾è±¡ãƒªãƒã‚¸ãƒˆãƒªã®ã‚¸ãƒ§ãƒ–IDã‚’æŠ½å‡º
          # jq ã‚’ä½¿ç”¨ã—ã¦JSONå½¢å¼ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‹ã‚‰æƒ…å ±ã‚’æŠ½å‡º
          JOB_ID=$(jq -r --arg repo "$TARGET_REPOSITORY" '.jobs[] | select(.title == $repo) | .jobId' ${CRON_JOBS_FILE})

          # ã‚¸ãƒ§ãƒ–IDãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
          if [ -z "$JOB_ID" ] || [ "$JOB_ID" = "null" ]; then
            echo "âŒ ã‚¨ãƒ©ãƒ¼: '$TARGET_REPOSITORY'ã«ä¸€è‡´ã™ã‚‹ã‚¸ãƒ§ãƒ–IDãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            echo "ðŸ” è€ƒãˆã‚‰ã‚Œã‚‹åŽŸå› :"
            echo "  - æŒ‡å®šã—ãŸãƒªãƒã‚¸ãƒˆãƒªåãŒæ­£ç¢ºã«ä¸€è‡´ã—ã¦ã„ãªã„"
            echo "  - ã“ã®ãƒªãƒã‚¸ãƒˆãƒªã®CronJobãŒç™»éŒ²ã•ã‚Œã¦ã„ãªã„"
            exit 1
          fi

          # ç¾åœ¨ã®æœ‰åŠ¹çŠ¶æ…‹ã‚’æŠ½å‡º
          CURRENT_STATUS=$(jq -r --arg repo "$TARGET_REPOSITORY" '.jobs[] | select(.title == $repo) | .enabled' ${CRON_JOBS_FILE})

          echo "ðŸ“‹ å¯¾è±¡ã‚¸ãƒ§ãƒ–ID: $JOB_ID"
          echo "ðŸ“‹ ç¾åœ¨ã®äºˆç´„çŠ¶æ…‹: $CURRENT_STATUS"

          # ç’°å¢ƒå¤‰æ•°ã«è¨­å®šã—ã¦å¾Œç¶šã‚¹ãƒ†ãƒƒãƒ—ã§ä½¿ç”¨ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
          echo "job_id=$JOB_ID" >> $GITHUB_ENV
          echo "current_status=$CURRENT_STATUS" >> $GITHUB_ENV
          echo "::endgroup::"

      # =============================
      # Step 3: äºˆç´„ã‚­ãƒ£ãƒ³ã‚»ãƒ«å‡¦ç†
      # =============================
      - name: äºˆç´„ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ï¼ˆç„¡åŠ¹åŒ–ï¼‰
        id: disable_job
        run: |
          echo "::group::CronJobã®ç„¡åŠ¹åŒ–"
          echo "ðŸ”„ ã‚¸ãƒ§ãƒ–ID: ${{ env.job_id }} ã®äºˆç´„ã‚’ç„¡åŠ¹åŒ–ä¸­..."

          # ã‚¸ãƒ§ãƒ–ã‚’ç„¡åŠ¹åŒ–ã™ã‚‹APIãƒªã‚¯ã‚¨ã‚¹ãƒˆ
          # enabled=false ã«è¨­å®šã™ã‚‹ã“ã¨ã§äºˆç´„ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
          curl -s -X PATCH \
            -H 'Content-Type: application/json' \
            -H "Authorization: Bearer ${{ secrets.CRON_JOB_TOKEN }}" \
            -d "{
              \"job\": {
                \"enabled\": false
              }
            }" \
            ${{ env.CRON_API_BASE_URL }}/${{ env.job_id }}

          # CronJob APIã‹ã‚‰ç„¡åŠ¹åŒ–ã—ãŸã‚¸ãƒ§ãƒ–æƒ…å ±ã‚’å–å¾—
          response=$(curl -X GET \
              -H 'Content-Type: application/json' \
              -H 'Authorization: Bearer ${{ secrets.CRON_JOB_TOKEN }}' \
              ${{ env.CRON_API_BASE_URL }}/${{ env.job_id }})

          # å–å¾—ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
          echo "$response" > ${CRON_JOBS_FILE_UPDATED}

          # ç¾åœ¨ã®æœ‰åŠ¹çŠ¶æ…‹ã‚’æŠ½å‡º
          UPDATE_STATUS=$(jq -r --arg repo "$TARGET_REPOSITORY" '.jobDetails[] | select(.title == $repo) | .enabled' ${CRON_JOBS_FILE_UPDATED})

          if [ "$UPDATE_STATUS" = "false" ]; then
            echo "âŒ ã‚¨ãƒ©ãƒ¼: CronJobã®ç„¡åŠ¹åŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ"
            echo "ðŸ” APIãƒ¬ã‚¹ãƒãƒ³ã‚¹: $UPDATE_STATUS"
            exit 1
          else
            echo "âœ… äºˆç´„ã®ç„¡åŠ¹åŒ–ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã—ã¾ã—ãŸ"
            echo "::endgroup::"
          fi

      # =============================
      # Step 4: æ›´æ–°å¾Œã®æƒ…å ±å–å¾—
      # =============================
      - name: æ›´æ–°å¾Œã®ã‚¸ãƒ§ãƒ–æƒ…å ±ã‚’å–å¾—
        id: verify_update
        run: |
          echo "::group::æ›´æ–°å¾Œã®ã‚¸ãƒ§ãƒ–æƒ…å ±å–å¾—"
          echo "ðŸ”„ æ›´æ–°å¾Œã®æƒ…å ±ã‚’ç¢ºèªä¸­..."

          # æ›´æ–°å¾Œã®ã‚¸ãƒ§ãƒ–æƒ…å ±ã‚’å†å–å¾—
          updated_response=$(curl -s -X GET \
              -H 'Content-Type: application/json' \
              -H 'Authorization: Bearer ${{ secrets.CRON_JOB_TOKEN }}' \
              ${{ env.CRON_API_BASE_URL }}) || {
                echo "âŒ ã‚¨ãƒ©ãƒ¼: æ›´æ–°å¾Œã®CronJobãƒªã‚¹ãƒˆå–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ"
                exit 1
              }

          # æ›´æ–°ã•ã‚ŒãŸæƒ…å ±ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
          echo "$updated_response" > ${UPDATED_JOBS_FILE}

          # æ›´æ–°å¾Œã®äºˆç´„æƒ…å ±ã‚’æŠ½å‡º
          NEW_STATUS=$(jq -r --arg repo "$TARGET_REPOSITORY" '.jobs[] | select(.title == $repo) | .enabled' ${UPDATED_JOBS_FILE})
          HOURS=$(jq -r --arg repo "$TARGET_REPOSITORY" '.jobs[] | select(.title == $repo) | .schedule.hours | @csv' ${UPDATED_JOBS_FILE})
          DAYS=$(jq -r --arg repo "$TARGET_REPOSITORY" '.jobs[] | select(.title == $repo) | .schedule.mdays | @csv' ${UPDATED_JOBS_FILE})
          MINUTES=$(jq -r --arg repo "$TARGET_REPOSITORY" '.jobs[] | select(.title == $repo) | .schedule.minutes | @csv' ${UPDATED_JOBS_FILE})
          MONTHS=$(jq -r --arg repo "$TARGET_REPOSITORY" '.jobs[] | select(.title == $repo) | .schedule.months | @csv' ${UPDATED_JOBS_FILE})
          TIMEZONE=$(jq -r --arg repo "$TARGET_REPOSITORY" '.jobs[] | select(.title == $repo) | .schedule.timezone' ${UPDATED_JOBS_FILE})

          # æ›´æ–°çµæžœã®ç¢ºèª
          if [ "$NEW_STATUS" = "true" ]; then
            echo "âš ï¸ è­¦å‘Š: äºˆç´„ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒæ­£ã—ãç„¡åŠ¹åŒ–ã•ã‚Œã¦ã„ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™"
          else
            echo "âœ… äºˆç´„ã®ç„¡åŠ¹åŒ–ãŒå®Œäº†ã—ã¾ã—ãŸ"
          fi

          # ç’°å¢ƒå¤‰æ•°ã«è¨­å®š
          echo "new_status=$NEW_STATUS" >> $GITHUB_ENV
          echo "schedule_hours=$HOURS" >> $GITHUB_ENV
          echo "schedule_days=$DAYS" >> $GITHUB_ENV
          echo "schedule_minutes=$MINUTES" >> $GITHUB_ENV
          echo "schedule_months=$MONTHS" >> $GITHUB_ENV
          echo "timezone=$TIMEZONE" >> $GITHUB_ENV
          echo "::endgroup::"

      # =============================
      # Step 5: çµæžœã‚µãƒžãƒªãƒ¼ä½œæˆ
      # =============================
      - name: çµæžœã®ã‚µãƒžãƒªãƒ¼ã‚’ä½œæˆ
        id: create_summary
        run: |
          {
            echo "# äºˆç´„ã‚­ãƒ£ãƒ³ã‚»ãƒ«çµæžœ"
            echo ""
            echo "## å‡¦ç†æ¦‚è¦"
            echo "- **å‡¦ç†æ—¥æ™‚**: $(date '+%Y-%m-%d %H:%M:%S')"
            echo "- **å®Ÿè¡Œè€…**: ${{ github.actor }}"
            echo ""
            echo "## å¯¾è±¡äºˆç´„æƒ…å ±"
            echo "| ãƒªãƒã‚¸ãƒˆãƒª | äºˆç´„æ—¥æ™‚ | äºˆç´„ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´ |"
            echo "| ---------- | -------- | ------------------ |"
            echo "| $TARGET_REPOSITORY | ${{ env.timezone }} ${{ env.schedule_months }}æœˆ${{ env.schedule_days }}æ—¥${{ env.schedule_hours }}æ™‚${{ env.schedule_minutes }}åˆ† | ${{ env.current_status }} â†’ ${{ env.new_status }} |"
            echo ""

            # ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã«åŸºã¥ã„ã¦çµæžœãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
            if [ "${{ env.new_status }}" = "false" ]; then
              echo "âœ… **çµæžœ**: äºˆç´„ã®ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã«æˆåŠŸã—ã¾ã—ãŸ"
            else
              echo "âš ï¸ **çµæžœ**: äºˆç´„ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®æ›´æ–°ã«å•é¡ŒãŒã‚ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚æ‰‹å‹•ã§ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
            fi

            echo ""
            echo "## å‚™è€ƒ"
            echo "- ã“ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯ CronJob.org ã®ç™»éŒ²äºˆç´„ã‚’ç„¡åŠ¹åŒ–ã™ã‚‹ã ã‘ã§ã‚ã‚Šã€äºˆç´„è‡ªä½“ã¯å‰Šé™¤ã•ã‚Œã¾ã›ã‚“"
            echo "- äºˆç´„ã‚’å†åº¦æœ‰åŠ¹åŒ–ã—ãŸã„å ´åˆã¯ã€CronJob.org ã®ç®¡ç†ç”»é¢ã‹ã‚‰æ‰‹å‹•ã§è¡Œã£ã¦ãã ã•ã„"
            echo "- äºˆç´„çŠ¶æ³ã‚’ç›´æŽ¥ç¢ºèªã™ã‚‹å ´åˆã¯ä»¥ä¸‹ã®ã‚µã‚¤ãƒˆã¸ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãã ã•ã„"
            echo "  [Cron-Job.orgç®¡ç†ç”»é¢](https://cron-job.org/en/)"
          } >> $GITHUB_STEP_SUMMARY
