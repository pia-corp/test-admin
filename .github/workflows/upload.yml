# ===================================================
# ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
# ===================================================
#
# æ¦‚è¦:
# ã“ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯ã€æŒ‡å®šã•ã‚ŒãŸãƒ–ãƒ©ãƒ³ãƒ‰ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œè¨¼ç’°å¢ƒã¾ãŸã¯æœ¬ç•ªç’°å¢ƒã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚
# å¤–éƒ¨APIã‹ã‚‰ã®ãƒˆãƒªã‚¬ãƒ¼(repository_dispatch)ã¨æ‰‹å‹•å®Ÿè¡Œ(workflow_dispatch)ã®ä¸¡æ–¹ã«å¯¾å¿œã—ã¦ã„ã¾ã™ã€‚
#
# ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹:
# 1. CI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã®ä¸€éƒ¨ã¨ã—ã¦ã€ãƒ“ãƒ«ãƒ‰å¾Œã«è‡ªå‹•çš„ã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
# 2. ç®¡ç†è€…ãŒGitHub Actions UIã‹ã‚‰æ‰‹å‹•ã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
# 3. å¤–éƒ¨ã‚·ã‚¹ãƒ†ãƒ ã‹ã‚‰APIã‚’é€šã˜ã¦ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’ãƒˆãƒªã‚¬ãƒ¼
#
# æ³¨æ„äº‹é …:
# - æ¤œè¨¼ç’°å¢ƒã§ã¯å¸¸ã«fullã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰(å·®åˆ†ã§ã¯ãªãå…¨ãƒ•ã‚¡ã‚¤ãƒ«)ãŒå®Ÿè¡Œã•ã‚Œã¾ã™
# - æœ¬ç•ªç’°å¢ƒã§ã¯åŒæœŸãƒ¢ãƒ¼ãƒ‰(full/delta)ã‚’é¸æŠžã§ãã¾ã™
# - ç’°å¢ƒã”ã¨ã«ç•°ãªã‚‹ãƒ—ãƒ­ãƒˆã‚³ãƒ«(æœ¬ç•ª:SFTPã€æ¤œè¨¼:FTP)ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™
#
# ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°æƒ…å ±:
#
# 1. Permission denied ã‚¨ãƒ©ãƒ¼ã®å ´åˆ:
#    - èªè¨¼æƒ…å ±ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼å/ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼‰ãŒæ­£ã—ã„ã‹ç¢ºèª
#    - ã‚µãƒ¼ãƒãƒ¼ã§ã®ã‚¢ã‚¯ã‚»ã‚¹åˆ¶é™ï¼ˆIPåˆ¶é™ãªã©ï¼‰ãŒãªã„ã‹ç¢ºèª
#
# 2. ç‰¹å®šã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚Œãªã„å ´åˆ:
#    - local-pathã¨remote-pathã®è¨­å®šãŒæ­£ã—ã„ã‹ç¢ºèª
#    - ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³ãŒæ­£ã—ã„ã‹ç¢ºèª
#
# 3. ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆãŒç™ºç”Ÿã™ã‚‹å ´åˆ:
#    - timeout-minutesã®å€¤ã‚’å¢—ã‚„ã™
#    - å¤§é‡ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚‹å ´åˆã¯åˆ†å‰²ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚’æ¤œè¨Ž
#
# ç’°å¢ƒå¤‰æ•°ã®è¨­å®šæ–¹æ³•:
# - PRODUCTION_*ãŠã‚ˆã³DEVELOPMENT_*ã®å¤‰æ•°/ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã¯
#   ãƒªãƒã‚¸ãƒˆãƒªè¨­å®šã®SecretsãŠã‚ˆã³Variablesã‹ã‚‰è¨­å®šã—ã¦ãã ã•ã„
#
# ===================================================

name: 02.ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰

# =============================
# ãƒˆãƒªã‚¬ãƒ¼è¨­å®š
# =============================
on:
  # å¤–éƒ¨APIã‹ã‚‰ã®ãƒˆãƒªã‚¬ãƒ¼ï¼ˆCI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚„ä»–ã®ã‚·ã‚¹ãƒ†ãƒ ã‹ã‚‰ã®å‘¼ã³å‡ºã—ç”¨ï¼‰
  repository_dispatch:
    types: [upload]

  # GitHubä¸Šã§ã®æ‰‹å‹•å®Ÿè¡Œç”¨ãƒˆãƒªã‚¬ãƒ¼
  workflow_dispatch:
    inputs:
      # å®šç¾©æ¸ˆã¿ãƒ–ãƒ©ãƒ³ãƒ‰ãƒªã‚¹ãƒˆï¼ˆãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã§é¸æŠžï¼‰
      repository:
        description: "å¯¾è±¡ãƒ–ãƒ©ãƒ³ãƒ‰ï¼ˆãƒªã‚¹ãƒˆã‹ã‚‰é¸æŠžï¼‰"
        type: choice
        required: true
        options:
          - "topards.jp"
          - "feliamo.jp"
          - "molak.jp"
          - "ns-collection.jp"
          - "lilmoon.jp"
          - "minette-lens.jp"
          - "mirage-c.jp"
          - "mimuco.jp"
          - "harne.jp"
          - "louer.jp"
          - "lumieu.jp"
          - "puuuuchu.jp"
          - "melady.jp"
          - "melloew.jp"
          - "faloom.jp"
          - "mimicharme.jp"
          - "lensbe.jp"
          - "clainel.jp"
          - "chapun.jp"
          - "resay.jp"
          - "michou.jp"

      # ãƒªã‚¹ãƒˆã«ãªã„ä»»æ„ã®ãƒ–ãƒ©ãƒ³ãƒ‰ï¼ˆè‡ªç”±å…¥åŠ›ï¼‰
      custom_repository:
        description: "ä»»æ„ã®ãƒ–ãƒ©ãƒ³ãƒ‰ãƒªãƒã‚¸ãƒˆãƒªï¼ˆãƒªã‚¹ãƒˆã«ãªã„å ´åˆï¼‰"
        required: false
        type: string

      # ãƒ‡ãƒ—ãƒ­ã‚¤å…ˆç’°å¢ƒã®é¸æŠž
      environment:
        description: "ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å…ˆç’°å¢ƒ"
        type: choice
        required: true
        options:
          - "æ¤œè¨¼ç’°å¢ƒ"
          - "æœ¬ç•ªç’°å¢ƒ"

      # åŒæœŸãƒ¢ãƒ¼ãƒ‰ã®é¸æŠžï¼ˆæ¤œè¨¼ç’°å¢ƒã§ã¯å¸¸ã«fullï¼‰
      sync_mode:
        description: "åŒæœŸãƒ¢ãƒ¼ãƒ‰ï¼ˆâ€»æ¤œè¨¼ç’°å¢ƒã¯fullã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã®ã¿ï¼‰"
        type: choice
        required: true
        options:
          - "full"  # å…¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å†ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
          - "delta" # å¤‰æ›´ãŒã‚ã£ãŸãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆæœ¬ç•ªç’°å¢ƒã®ã¿æœ‰åŠ¹ï¼‰

# =============================
# ã‚¸ãƒ§ãƒ–å®šç¾©
# =============================
jobs:
  Upload:
    runs-on: ubuntu-latest
    timeout-minutes: 5  # ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®šï¼ˆé•·æ™‚é–“ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚’é˜²æ­¢ï¼‰

    # =============================
    # ç’°å¢ƒå¤‰æ•°ã®è¨­å®š
    # - ã‚¤ãƒ™ãƒ³ãƒˆã‚¿ã‚¤ãƒ—ã«å¿œã˜ã¦ç•°ãªã‚‹ã‚½ãƒ¼ã‚¹ã‹ã‚‰å€¤ã‚’å–å¾—
    # - å¿…è¦ã«å¿œã˜ã¦ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’è¨­å®š
    # =============================
    env:
      # å¯¾è±¡ãƒªãƒã‚¸ãƒˆãƒªï¼ˆãƒ–ãƒ©ãƒ³ãƒ‰ï¼‰åã®æ±ºå®šãƒ­ã‚¸ãƒƒã‚¯
      # 1. repository_dispatchã®å ´åˆ: client_payloadã‹ã‚‰ã®å€¤ã‚’ä½¿ç”¨
      # 2. workflow_dispatchã®å ´åˆ: inputsã‹ã‚‰ã®å€¤ã‚’ä½¿ç”¨
      # 3. custom_repositoryãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚Œã°ãã¡ã‚‰ã‚’å„ªå…ˆ
      TARGET_REPOSITORY: ${{ github.event_name == 'repository_dispatch' && (github.event.client_payload.custom_repository && github.event.client_payload.custom_repository || github.event.client_payload.repository) || github.event_name == 'workflow_dispatch' && (inputs.custom_repository && inputs.custom_repository || inputs.repository) }}

      # ãƒ‡ãƒ—ãƒ­ã‚¤å…ˆç’°å¢ƒã®æ±ºå®šãƒ­ã‚¸ãƒƒã‚¯ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: æ¤œè¨¼ç’°å¢ƒï¼‰
      TARGET_ENVIRONMENT: ${{ github.event.client_payload.target && github.event.client_payload.target || inputs.target && inputs.target || 'æ¤œè¨¼ç’°å¢ƒ' }}

      # åŒæœŸãƒ¢ãƒ¼ãƒ‰ã®æ±ºå®šãƒ­ã‚¸ãƒƒã‚¯ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: fullï¼‰
      SYNC_MODE: ${{ github.event.client_payload.sync && github.event.client_payload.sync || inputs.sync && inputs.sync || 'full' }}

    steps:
      # =============================
      # ã‚¹ãƒ†ãƒƒãƒ—1: ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      # - ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¯¾è±¡ã®ãƒ•ã‚¡ã‚¤ãƒ«ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãŸã‚ã«å¿…è¦
      # =============================
      - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4.2.2
        # æ³¨: å¿…è¦ã«å¿œã˜ã¦fetch-depthã‚„submodulesãªã©ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ å¯èƒ½

      # =============================
      # ã‚¹ãƒ†ãƒƒãƒ—2A: æœ¬ç•ªç’°å¢ƒã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆSFTPä½¿ç”¨ï¼‰
      # - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å‘ä¸Šã®ãŸã‚SFTPã‚’ä½¿ç”¨
      # - deltaåŒæœŸã«å¯¾å¿œï¼ˆå¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¯èƒ½ï¼‰
      # =============================
      - name: æœ¬ç•ªç’°å¢ƒã¸ã®SFTPãƒ‡ãƒ—ãƒ­ã‚¤
        if: ${{ env.TARGET_ENVIRONMENT == 'æœ¬ç•ªç’°å¢ƒ' }}
        uses: milanmk/actions-file-deployer@1.15
        with:
          remote-protocol: 'sftp'
          remote-host: ${{ vars.PRODUCTION_HOST }}
          remote-port: ${{ vars.PRODUCTION_PORT }}
          remote-user: ${{ vars.PRODUCTION_USER_NAME }}
          remote-password: ${{ secrets.PRODUCTION_PASSWORD }}
          local-path: out/${{ env.TARGET_REPOSITORY }}  # ãƒ­ãƒ¼ã‚«ãƒ«ã®å¯¾è±¡ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
          remote-path: ${{ env.TARGET_REPOSITORY }}/${{ vars.PRODUCTION_REMOTE_PATH }}/  # ãƒªãƒ¢ãƒ¼ãƒˆã®å¯¾è±¡ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
          sync: ${{ env.SYNC_MODE }}  # åŒæœŸãƒ¢ãƒ¼ãƒ‰ï¼ˆfull/deltaï¼‰
          debug: true  # ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ã‚’æœ‰åŠ¹åŒ–ï¼ˆãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã®ãŸã‚ï¼‰

      # =============================
      # ã‚¹ãƒ†ãƒƒãƒ—2B: æœ¬ç•ªç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤çµæžœã®ã‚µãƒžãƒªãƒ¼è¡¨ç¤º
      # - ãƒ‡ãƒ—ãƒ­ã‚¤çµæžœã‚’ã‚ã‹ã‚Šã‚„ã™ãè¡¨ç¤º
      # - GitHub Actionsã®å®Ÿè¡Œã‚µãƒžãƒªãƒ¼ã«è¡¨ç¤ºã•ã‚Œã‚‹
      # =============================
      - name: æœ¬ç•ªç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤çµæžœã‚µãƒžãƒªãƒ¼
        if: ${{ env.TARGET_ENVIRONMENT == 'æœ¬ç•ªç’°å¢ƒ' }}
        run: |
          {
            echo "# ðŸš€ ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†ãƒ¬ãƒãƒ¼ãƒˆ"
            echo "æŒ‡å®šã—ãŸãƒ–ãƒ©ãƒ³ãƒ‰ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æœ¬ç•ªã‚µãƒ¼ãƒã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸã€‚"
            echo ""
            echo "| ãƒ–ãƒ©ãƒ³ãƒ‰ | ã‚¢ã‚¯ã‚»ã‚¹URL |"
            echo "| ------ | ------------ |"
            echo "| ${{ env.TARGET_REPOSITORY }} | https://www.${{ env.TARGET_REPOSITORY }} |"
            echo ""
            echo "## ðŸ“‹ è©³ç´°æƒ…å ±"
            echo "- **ç’°å¢ƒ**: æœ¬ç•ªç’°å¢ƒ"
            echo "- **ãƒ–ãƒ©ãƒ³ãƒ‰**: ${{ env.TARGET_REPOSITORY }}"
            echo "- **åŒæœŸãƒ¢ãƒ¼ãƒ‰**: ${{ env.SYNC_MODE }}"
            echo "- **å®Ÿè¡Œæ—¥æ™‚**: $(date "+%Y-%m-%d %H:%M:%S")"
            echo "- **å®Ÿè¡Œè€…**: ${{ github.actor }}"
          } >> $GITHUB_STEP_SUMMARY

      # =============================
      # ã‚¹ãƒ†ãƒƒãƒ—3A: æ¤œè¨¼ç’°å¢ƒã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆFTPä½¿ç”¨ï¼‰
      # - æ¤œè¨¼ç’°å¢ƒã¯å¸¸ã«fullã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆå…¨ãƒ•ã‚¡ã‚¤ãƒ«å†é…ç½®ï¼‰
      # - ç•°ãªã‚‹FTPãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ç”¨ï¼ˆæ¤œè¨¼ç’°å¢ƒå°‚ç”¨ï¼‰
      # =============================
      # - name: æ¤œè¨¼ç’°å¢ƒã¸ã®FTPãƒ‡ãƒ—ãƒ­ã‚¤
      #   if: ${{ env.TARGET_ENVIRONMENT == 'æ¤œè¨¼ç’°å¢ƒ' }}
      #   uses: SamKirkland/FTP-Deploy-Action@v4.3.5
      #   with:
      #     server: ${{ vars.DEVELOPMENT_HOST }}
      #     username: ${{ vars.DEVELOPMENT_USER_NAME }}
      #     password: ${{ secrets.DEVELOPMENT_PASSWORD }}
      #     port: ${{ vars.DEVELOPMENT_PORT }}
      #     local-dir: out/${{ env.TARGET_REPOSITORY }}/  # ãƒ­ãƒ¼ã‚«ãƒ«ã®å¯¾è±¡ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
      #     server-dir: ${{ vars.DEVELOPMENT_REMOTE_PATH }}/${{ env.TARGET_REPOSITORY }}/  # ãƒªãƒ¢ãƒ¼ãƒˆã®å¯¾è±¡ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
      #     # æ³¨: ã“ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã¯deltaãƒ¢ãƒ¼ãƒ‰ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ãªã„ãŸã‚ã€å¸¸ã«fullã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«ãªã‚‹

      # =============================
      # ã‚¹ãƒ†ãƒƒãƒ—3B: æ¤œè¨¼ç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤çµæžœã®ã‚µãƒžãƒªãƒ¼è¡¨ç¤º
      # - ãƒ‡ãƒ—ãƒ­ã‚¤çµæžœã‚’ã‚ã‹ã‚Šã‚„ã™ãè¡¨ç¤º
      # - GitHub Actionsã®å®Ÿè¡Œã‚µãƒžãƒªãƒ¼ã«è¡¨ç¤ºã•ã‚Œã‚‹
      # =============================
      - name: æ¤œè¨¼ç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤çµæžœã‚µãƒžãƒªãƒ¼
        if: ${{ env.TARGET_ENVIRONMENT == 'æ¤œè¨¼ç’°å¢ƒ' }}
        run: |
          {
            echo "# ðŸš€ ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†ãƒ¬ãƒãƒ¼ãƒˆ"
            echo "æŒ‡å®šã—ãŸãƒ–ãƒ©ãƒ³ãƒ‰ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œè¨¼ã‚µãƒ¼ãƒã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸã€‚"
            echo ""
            echo "| ãƒ–ãƒ©ãƒ³ãƒ‰ | ã‚¢ã‚¯ã‚»ã‚¹URL |"
            echo "| ------ | ------------ |"
            echo "| ${{ env.TARGET_REPOSITORY }} | http://piapiapia.xsrv.jp/test/${{ env.TARGET_REPOSITORY }}/ |"
            echo ""
            echo "## ðŸ“‹ è©³ç´°æƒ…å ±"
            echo "- **ç’°å¢ƒ**: æ¤œè¨¼ç’°å¢ƒ"
            echo "- **ãƒ–ãƒ©ãƒ³ãƒ‰**: ${{ env.TARGET_REPOSITORY }}"
            echo "- **åŒæœŸãƒ¢ãƒ¼ãƒ‰**: fullï¼ˆæ¤œè¨¼ç’°å¢ƒã¯å¸¸ã«fullï¼‰"
            echo "- **å®Ÿè¡Œæ—¥æ™‚**: $(date "+%Y-%m-%d %H:%M:%S")"
            echo "- **å®Ÿè¡Œè€…**: ${{ github.actor }}"
          } >> $GITHUB_STEP_SUMMARY
