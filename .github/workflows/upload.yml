# ===================================================
# ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
# ===================================================
#
# æ¦‚è¦:
# ã“ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯ã€æŒ‡å®šã•ã‚ŒãŸãƒ–ãƒ©ãƒ³ãƒ‰ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œè¨¼ç’°å¢ƒã¾ãŸã¯æœ¬ç•ªç’°å¢ƒã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚
# å¤–éƒ¨APIã‹ã‚‰ã®ãƒˆãƒªã‚¬ãƒ¼(repository_dispatch)ã¨æ‰‹å‹•å®Ÿè¡Œ(workflow_dispatch)ã®ä¸¡æ–¹ã«å¯¾å¿œã—ã¦ã„ã¾ã™ã€‚
#
# ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹:
# 1. CI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã®ä¸€éƒ¨ã¨ã—ã¦ã€ãƒ“ãƒ«ãƒ‰å¾Œã«è‡ªå‹•çš„ã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
# 2. ç®¡ç†è€…ãŒGitHub Actions UIã‹ã‚‰æ‰‹å‹•ã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
# 3. å¤–éƒ¨ã‚·ã‚¹ãƒ†ãƒ ã‹ã‚‰APIã‚’é€šã˜ã¦ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’ãƒˆãƒªã‚¬ãƒ¼
#
# æ³¨æ„äº‹é …:
# - æ¤œè¨¼ç’°å¢ƒã§ã¯å¸¸ã«fullã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰(å·®åˆ†ã§ã¯ãªãå…¨ãƒ•ã‚¡ã‚¤ãƒ«)ãŒå®Ÿè¡Œã•ã‚Œã¾ã™
# - æœ¬ç•ªç’°å¢ƒã§ã¯åŒæœŸãƒ¢ãƒ¼ãƒ‰(full/delta)ã‚’é¸æŠžã§ãã¾ã™
# - ç’°å¢ƒã”ã¨ã«ç•°ãªã‚‹ãƒ—ãƒ­ãƒˆã‚³ãƒ«(æœ¬ç•ª:SFTPã€æ¤œè¨¼:FTP)ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™
#
# ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°æƒ…å ±:
#
# 1. Permission denied ã‚¨ãƒ©ãƒ¼ã®å ´åˆ:
#    - èªè¨¼æƒ…å ±ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼å/ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼‰ãŒæ­£ã—ã„ã‹ç¢ºèª
#    - ã‚µãƒ¼ãƒãƒ¼ã§ã®ã‚¢ã‚¯ã‚»ã‚¹åˆ¶é™ï¼ˆIPåˆ¶é™ãªã©ï¼‰ãŒãªã„ã‹ç¢ºèª
#
# 2. ç‰¹å®šã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚Œãªã„å ´åˆ:
#    - local-pathã¨remote-pathã®è¨­å®šãŒæ­£ã—ã„ã‹ç¢ºèª
#    - ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³ãŒæ­£ã—ã„ã‹ç¢ºèª
#
# 3. ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆãŒç™ºç”Ÿã™ã‚‹å ´åˆ:
#    - timeout-minutesã®å€¤ã‚’å¢—ã‚„ã™
#    - å¤§é‡ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚‹å ´åˆã¯åˆ†å‰²ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚’æ¤œè¨Ž
#
# ç’°å¢ƒå¤‰æ•°ã®è¨­å®šæ–¹æ³•:
# - PRODUCTION_*ãŠã‚ˆã³DEVELOPMENT_*ã®å¤‰æ•°/ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã¯ãƒªãƒã‚¸ãƒˆãƒªè¨­å®šã®SecretsãŠã‚ˆã³Variablesã‹ã‚‰è¨­å®šã—ã¦ãã ã•ã„
#
# ===================================================

name: 02.ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰

# =============================
# ãƒˆãƒªã‚¬ãƒ¼è¨­å®š
# =============================
on:
  repository_dispatch:
    types: [upload]

  workflow_dispatch:
    inputs:
      repository:
        description: "ä»»æ„ã®ãƒ–ãƒ©ãƒ³ãƒ‰ãƒªãƒã‚¸ãƒˆãƒªï¼ˆãƒªã‚¹ãƒˆã«ãªã„å ´åˆï¼‰"
        required: true
        type: string

      environment:
        description: "ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å…ˆç’°å¢ƒ"
        type: choice
        required: true
        options:
          - "æ¤œè¨¼ç’°å¢ƒ"
          - "æœ¬ç•ªç’°å¢ƒ"

      sync_mode:
        description: "åŒæœŸãƒ¢ãƒ¼ãƒ‰ï¼ˆâ€»æ¤œè¨¼ç’°å¢ƒã¯fullã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã®ã¿ï¼‰"
        type: choice
        required: true
        options:
          - "full"
          - "delta"

# =============================
# ã‚¸ãƒ§ãƒ–å®šç¾©
# =============================
jobs:
  Upload:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    # =============================
    # ç’°å¢ƒå¤‰æ•°ã®è¨­å®š
    # - ã‚¤ãƒ™ãƒ³ãƒˆã‚¿ã‚¤ãƒ—ã«å¿œã˜ã¦ç•°ãªã‚‹ã‚½ãƒ¼ã‚¹ã‹ã‚‰å€¤ã‚’å–å¾—
    # - å¿…è¦ã«å¿œã˜ã¦ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’è¨­å®š
    # =============================
    env:
      # å¯¾è±¡ãƒªãƒã‚¸ãƒˆãƒªï¼ˆãƒ–ãƒ©ãƒ³ãƒ‰ï¼‰åã®æ±ºå®šãƒ­ã‚¸ãƒƒã‚¯
      # 1. repository_dispatchã®å ´åˆ: client_payloadã‹ã‚‰ã®å€¤ã‚’ä½¿ç”¨
      # 2. workflow_dispatchã®å ´åˆ: inputsã‹ã‚‰ã®å€¤ã‚’ä½¿ç”¨
      # 3. repositoryãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚Œã°ãã¡ã‚‰ã‚’å„ªå…ˆ
      # HOST ã®æ±ºå®š
      HOST: ${{ github.event_name == 'repository_dispatch' && github.event.client_payload.environment == 'æœ¬ç•ªç’°å¢ƒ' && vars.PRODUCTION_HOST ||
        github.event_name == 'repository_dispatch' && github.event.client_payload.environment == 'æ¤œè¨¼ç’°å¢ƒ' && vars.DEVELOPMENT_HOST ||
        github.event_name == 'workflow_dispatch' && inputs.environment == 'æœ¬ç•ªç’°å¢ƒ' && vars.PRODUCTION_HOST ||
        github.event_name == 'workflow_dispatch' && inputs.environment == 'æ¤œè¨¼ç’°å¢ƒ' && vars.DEVELOPMENT_HOST }}

      # PORT ã®æ±ºå®š
      PORT: ${{ github.event_name == 'repository_dispatch' && github.event.client_payload.environment == 'æœ¬ç•ªç’°å¢ƒ'  && vars.PRODUCTION_PORT ||
        github.event_name == 'repository_dispatch' && github.event.client_payload.environment == 'æ¤œè¨¼ç’°å¢ƒ' && vars.DEVELOPMENT_PORT ||
        github.event_name == 'workflow_dispatch' && inputs.environment == 'æœ¬ç•ªç’°å¢ƒ' && vars.PRODUCTION_PORT ||
        github.event_name == 'workflow_dispatch' && inputs.environment == 'æ¤œè¨¼ç’°å¢ƒ' && vars.DEVELOPMENT_PORT }}

      # USER_NAME ã®æ±ºå®š
      USER_NAME: ${{ github.event_name == 'repository_dispatch' && github.event.client_payload.environment == 'æœ¬ç•ªç’°å¢ƒ' && vars.PRODUCTION_USER_NAME ||
        github.event_name == 'repository_dispatch' && github.event.client_payload.environment == 'æ¤œè¨¼ç’°å¢ƒ' && vars.DEVELOPMENT_USER_NAME ||
        github.event_name == 'workflow_dispatch' && inputs.environment == 'æœ¬ç•ªç’°å¢ƒ' && vars.PRODUCTION_USER_NAME ||
        github.event_name == 'workflow_dispatch' && inputs.environment == 'æ¤œè¨¼ç’°å¢ƒ' && vars.DEVELOPMENT_USER_NAME }}

      # LOCAL_PATH ã®æ±ºå®š
      LOCAL_PATH: ${{ vars.LOCAL_PATH }}${{ github.event_name == 'repository_dispatch' && github.event.client_payload.repository ||
        github.event_name == 'workflow_dispatch' && inputs.repository }}

      # REMOTE_PATH ã®æ±ºå®š
      REMOTE_PATH: ${{ github.event_name == 'repository_dispatch' && github.event.client_payload.environment == 'æœ¬ç•ªç’°å¢ƒ' && format('{0}/{1}', inputs.repository, vars.PRODUCTION_REMOTE_PATH) ||
        github.event_name == 'repository_dispatch' && github.event.client_payload.environment == 'æ¤œè¨¼ç’°å¢ƒ' && format('{0}/{1}', vars.DEVELOPMENT_REMOTE_PATH, inputs.repository) ||
        github.event_name == 'workflow_dispatch' && inputs.environment == 'æœ¬ç•ªç’°å¢ƒ' && format('{0}/{1}', inputs.repository, vars.PRODUCTION_REMOTE_PATH) ||
        github.event_name == 'workflow_dispatch' && inputs.environment == 'æ¤œè¨¼ç’°å¢ƒ' && format('{0}/{1}', vars.DEVELOPMENT_REMOTE_PATH, inputs.repository) }}

      # SYNC_MODE ã®æ±ºå®š
      SYNC_MODE: ${{ github.event_name == 'repository_dispatch' && github.event.client_payload.sync_mode ||
        github.event_name == 'workflow_dispatch' && inputs.sync_mode }}

      TARGET_REPOSITORY: ${{ github.event_name == 'repository_dispatch' && (github.event.client_payload.repository && github.event.client_payload.repository || github.event.client_payload.repository) || github.event_name == 'workflow_dispatch' && (inputs.repository && inputs.repository || inputs.repository) }}

      # ãƒ‡ãƒ—ãƒ­ã‚¤å…ˆç’°å¢ƒã®æ±ºå®šãƒ­ã‚¸ãƒƒã‚¯ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: æ¤œè¨¼ç’°å¢ƒï¼‰
      TARGET_ENVIRONMENT: ${{ github.event.client_payload.target && github.event.client_payload.target || inputs.target && inputs.target || 'æ¤œè¨¼ç’°å¢ƒ' }}


    steps:
      # =============================
      # ã‚¹ãƒ†ãƒƒãƒ—1: ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      # - ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¯¾è±¡ã®ãƒ•ã‚¡ã‚¤ãƒ«ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãŸã‚ã«å¿…è¦
      # =============================
      - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4.2.2
        with:
          fetch-depth: 0

      # =============================
      # ã‚¹ãƒ†ãƒƒãƒ—2A: æœ¬ç•ªç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆSFTPä½¿ç”¨ï¼‰
      # - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å‘ä¸Šã®ãŸã‚SFTPã‚’ä½¿ç”¨
      # - deltaåŒæœŸã«å¯¾å¿œï¼ˆå¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¯èƒ½ï¼‰
      # =============================
      - name: SFTPãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆæœ¬ç•ªç’°å¢ƒï¼‰
        if: ${{ env.TARGET_ENVIRONMENT == 'æœ¬ç•ªç’°å¢ƒ' }}
        uses: milanmk/actions-file-deployer@1.15
        with:
          remote-protocol: 'sftp'
          remote-host: ${{ env.HOST }}
          remote-port: ${{ env.PORT }}
          remote-user: ${{ env.USER_NAME }}
          remote-password: ${{ secrets.PRODUCTION_PASSWORD }}
          local-path: ${{ env.LOCAL_PATH }}
          remote-path: ${{ env.REMOTE_PATH }}
          sync: ${{ env.SYNC_MODE }}
          debug: false


      # =============================
      # ã‚¹ãƒ†ãƒƒãƒ—2A: æ¤œè¨¼ç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆSFTPä½¿ç”¨ï¼‰
      # - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å‘ä¸Šã®ãŸã‚SFTPã‚’ä½¿ç”¨
      # - deltaåŒæœŸã«å¯¾å¿œï¼ˆå¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¯èƒ½ï¼‰
      # =============================
      - name: Use SSH private key from GitHub Secrets
        run: |
          if [ ! -d "~/.ssh" ]; then
            mkdir -p ~/.ssh  # SSHãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
          fi
          # GitHub Secretsã‹ã‚‰æš—å·åŒ–ã•ã‚ŒãŸãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã‚­ãƒ¼ã‚’å–ã‚Šå‡ºã—ã€ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
          echo "${{ secrets.DEVELOPMENT_SSH_KEY }}" > ~/.ssh/id_rsa.enc
          # å¾©å·åŒ–ã®ãŸã‚ã®ãƒ‘ã‚¹ãƒ•ãƒ¬ãƒ¼ã‚ºã‚’GitHub Secretsã‹ã‚‰å–å¾—ï¼ˆã‚‚ã—ã‚ã‚Œã°ï¼‰
          echo "${{ secrets.SSH_PASSPHRASE }}" | openssl rsa -in ~/.ssh/id_rsa.enc -out ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa  # ãƒ‘ãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³ã‚’è¨­å®š
          # configãƒ•ã‚¡ã‚¤ãƒ«ãŒãªã„å ´åˆã«ä½œæˆï¼ˆå¿…è¦ãªå ´åˆï¼‰
          echo -e "Host ${{ env.HOST }}\n  User ${{ env.USER_NAME }}\n  Port ${{ env.PORT }}\n  IdentityFile ~/.ssh/id_rsa\n" > ~/.ssh/config
          ssh -v -p ${{ env.PORT }} -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ${{ env.USER_NAME }}@${{ env.HOST }} "mkdir -p ${{ env.REMOTE_PATH }}"

      # 2. ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤
      - name: Deploy files to the remote server (æ¤œè¨¼ç’°å¢ƒ)
        uses: milanmk/actions-file-deployer@1.16
        with:
          remote-protocol: 'sftp'
          remote-host: ${{ env.HOST }}
          remote-port: ${{ env.PORT }}
          remote-user: ${{ env.USER_NAME }}
          ssh-private-key: ~/.ssh/id_rsa
          local-path: ${{ env.LOCAL_PATH }}
          remote-path: ${{ env.REMOTE_PATH }}
          sync: ${{ env.SYNC_MODE }}
          debug: true
          ftp-post-sync-commands: |
            mirror --reverse --delete . ${{ env.REMOTE_PATH }}

      # =============================
      # ã‚¹ãƒ†ãƒƒãƒ—2B: æœ¬ç•ªç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤çµæžœã®ã‚µãƒžãƒªãƒ¼è¡¨ç¤º
      # - ãƒ‡ãƒ—ãƒ­ã‚¤çµæžœã‚’ã‚ã‹ã‚Šã‚„ã™ãè¡¨ç¤º
      # - GitHub Actionsã®å®Ÿè¡Œã‚µãƒžãƒªãƒ¼ã«è¡¨ç¤ºã•ã‚Œã‚‹
      # =============================
      - name: æœ¬ç•ªç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤çµæžœã‚µãƒžãƒªãƒ¼
        if: ${{ env.TARGET_ENVIRONMENT == 'æœ¬ç•ªç’°å¢ƒ' }}
        run: |
          {
            echo "# ðŸš€ ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†ãƒ¬ãƒãƒ¼ãƒˆ"
            echo "æŒ‡å®šã—ãŸãƒ–ãƒ©ãƒ³ãƒ‰ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æœ¬ç•ªã‚µãƒ¼ãƒã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸã€‚"
            echo ""
            echo "| ãƒ–ãƒ©ãƒ³ãƒ‰ | ã‚¢ã‚¯ã‚»ã‚¹URL |"
            echo "| ------ | ------------ |"
            echo "| ${{ env.TARGET_REPOSITORY }} | https://www.${{ env.TARGET_REPOSITORY }} |"
            echo ""
            echo "## ðŸ“‹ è©³ç´°æƒ…å ±"
            echo "- **ç’°å¢ƒ**: æœ¬ç•ªç’°å¢ƒ"
            echo "- **ãƒ–ãƒ©ãƒ³ãƒ‰**: ${{ env.TARGET_REPOSITORY }}"
            echo "- **åŒæœŸãƒ¢ãƒ¼ãƒ‰**: ${{ env.SYNC_MODE }}"
            echo "- **å®Ÿè¡Œæ—¥æ™‚**: $(date "+%Y-%m-%d %H:%M:%S")"
            echo "- **å®Ÿè¡Œè€…**: ${{ github.actor }}"
          } >> $GITHUB_STEP_SUMMARY

      # =============================
      # ã‚¹ãƒ†ãƒƒãƒ—3B: æ¤œè¨¼ç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤çµæžœã®ã‚µãƒžãƒªãƒ¼è¡¨ç¤º
      # - ãƒ‡ãƒ—ãƒ­ã‚¤çµæžœã‚’ã‚ã‹ã‚Šã‚„ã™ãè¡¨ç¤º
      # - GitHub Actionsã®å®Ÿè¡Œã‚µãƒžãƒªãƒ¼ã«è¡¨ç¤ºã•ã‚Œã‚‹
      # =============================
      - name: æ¤œè¨¼ç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤çµæžœã‚µãƒžãƒªãƒ¼
        if: ${{ env.TARGET_ENVIRONMENT == 'æ¤œè¨¼ç’°å¢ƒ' }}
        run: |
          {
            echo "# ðŸš€ ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†ãƒ¬ãƒãƒ¼ãƒˆ"
            echo "æŒ‡å®šã—ãŸãƒ–ãƒ©ãƒ³ãƒ‰ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œè¨¼ã‚µãƒ¼ãƒã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸã€‚"
            echo ""
            echo "| ãƒ–ãƒ©ãƒ³ãƒ‰ | ã‚¢ã‚¯ã‚»ã‚¹URL |"
            echo "| ------ | ------------ |"
            echo "| ${{ env.TARGET_REPOSITORY }} | http://piapiapia.xsrv.jp/dev/${{ env.TARGET_REPOSITORY }}/ |"
            echo ""
            echo "## ðŸ“‹ è©³ç´°æƒ…å ±"
            echo "- **ç’°å¢ƒ**: æ¤œè¨¼ç’°å¢ƒ"
            echo "- **ãƒ–ãƒ©ãƒ³ãƒ‰**: ${{ env.TARGET_REPOSITORY }}"
            echo "- **åŒæœŸãƒ¢ãƒ¼ãƒ‰**: ${{ env.SYNC_MODE }}"
            echo "- **å®Ÿè¡Œæ—¥æ™‚**: $(date "+%Y-%m-%d %H:%M:%S")"
            echo "- **å®Ÿè¡Œè€…**: ${{ github.actor }}"
          } >> $GITHUB_STEP_SUMMARY
