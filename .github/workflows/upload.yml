name: 02.手動ファイルアップロード

on:
  workflow_dispatch:
    inputs:
      repository:
        type: choice
        description: "対象ブランド"
        required: true
        options:
          - "topards.jp"
          - "feliamo.jp"
          - "molak.jp"
          - "ns-collection.jp"
          - "lilmoon.jp"
          - "minette-lens.jp"
          - "mirage-c.jp"
          - "mimuco.jp"
          - "harne.jp"
          - "louer.jp"
          - "lumieu.jp"
          - "puuuuchu.jp"
          - "melady.jp"
          - "melloew.jp"
          - "faloom.jp"
          - "mimicharme.jp"
          - "lensbe.jp"
          - "clainel.jp"
          - "chapun.jp"
          - "resay.jp"
          - "michou.jp"
      repository_no_register:
        description: "任意のブランドリポジトリ"
        default: ""
      target:
        type: choice
        description: アップロード先
        required: true
        options:
          - "検証環境"
          - "本番環境"
      sync:
        type: choice
        description: "※検証環境はfullアップロードのみ"
        required: true
        options:
          - "full"
          - "delta"

jobs:
  # このジョブは、ワークフローを実行するユーザーが許可されたリストに含まれているかどうかを確認します。
  Auth:
    runs-on: ubuntu-latest
    timeout-minutes: 1

    steps:
      - name: ユーザーの認証を確認
        env:
          USER_LOGIN: ${{ github.actor }}
          CODE_OWNERS: ${{ vars.GIT_CODE_OWNERS }}
        run: |
          echo "$USER_LOGIN が許可されたリストに含まれているか確認しています..."
          if ! echo "$CODE_OWNERS" | grep -q -w "$USER_LOGIN"; then
            echo "::warning:: ユーザー $USER_LOGIN はこのワークフローを実行する権限がありません。"
            exit 1
          fi
          echo "::notice:: ユーザー $USER_LOGIN は認証されました。続行します..."

  Upload:
    needs: [Auth]
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      REPOSITORY: ${{ inputs.repository_no_register != '' && inputs.repository_no_register || inputs.repository }}
    permissions:
      contents: read

    steps:
      - name: リポジトリをチェックアウト(過去の履歴をすべて取得)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 本番環境か検証環境
        run: |
          if (target == '検証環境') {
            echo "HOST=${{ vars.DEVELOPMENT_HOST }}" >> $GITHUB_ENV
            echo "PORT=${{ vars.DEVELOPMENT_PORT }}" >> $GITHUB_ENV
            echo "USER_NAME=${{ vars.DEVELOPMENT_USER_NAME }}" >> $GITHUB_ENV
            echo "PASSWORD=${{ secrets.DEVELOPMENT_PASSWORD }}" >> $GITHUB_ENV
            echo "PORT=${{ vars.DEVELOPMENT_REMOTE_PATH }}" >> $GITHUB_ENV
          } else {
            echo "HOST=${{ vars.PRODUCTION_HOST }}" >> $GITHUB_ENV
            echo "PORT=${{ vars.PRODUCTION_PORT }}" >> $GITHUB_ENV
            echo "USER_NAME=${{ vars.PRODUCTION_USER_NAME }}" >> $GITHUB_ENV
            echo "PASSWORD=${{ secrets.PRODUCTION_PASSWORD }}" >> $GITHUB_ENV
          }

      - name: Deploy via SFTP
        if: ${{ inputs.target == '本番環境' }}
        uses: milanmk/actions-file-deployer@1.15
        with:
          remote-protocol: 'sftp'
          remote-host: ${{ env.HOST }}
          remote-port: ${{ env.PORT }}
          remote-user: ${{ env.USER_NAME }}
          remote-password: ${{ env.PASSWORD }}
          local-path: ${{ vars.LOCAL_PATH }}/${{ env.REPOSITORY }}
          remote-path: ${{ env.REPOSITORY }}
          sync: ${{ inputs.sync }}
          debug: true

      - name: 結果
        if: ${{ inputs.target == '本番環境' }}
        run: |
          {
            echo "# 処理結果"
            echo "指定したリポジトリ（ブランド）のファイルをサーバにアップロードしました。"
            echo "| リポジトリ | アップロード先 |"
            echo "| -- | -- |"
            echo "| ${{ env.REPOSITORY }} | https://www.${{ env.REPOSITORY }} |"
          } >> $GITHUB_STEP_SUMMARY

      - name: Deploy via FTP
        if: ${{ inputs.target == '検証環境' }}
        uses: SamKirkland/FTP-Deploy-Action@4.3.4
        with:
          server: ${{ env.HOST }}
          username: ${{ env.USER_NAME }}
          password: ${{ env.PASSWORD }}
          port:  ${{ env.PORT }}
          local-dir: ${{ vars.LOCAL_PATH }}/${{ env.REPOSITORY }}
          server-dir: ${{ env.DEVELOPMENT_REMOTE_PATH }}/${{ env.REPOSITORY }}
          ARGS: --delete --parallel=15

      - name: 結果
        if: ${{ inputs.target == '検証環境' }}
        run: |
          {
            echo "# 処理結果"
            echo "指定したリポジトリ（ブランド）のファイルをサーバにアップロードしました。"
            echo "| リポジトリ | アップロード先 |"
            echo "| -- | -- |"
            echo "| ${{ env.REPOSITORY }} | http://piapiapia.xsrv.jp/test/${{ env.REPOSITORY }}/ |"
          } >> $GITHUB_STEP_SUMMARY
